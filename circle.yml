machine:
  environment:
    INSTALL_PREFIX_DIR_HOME_REL: ~/opt
    INSTALL_PREFIX_DIR: ${HOME}/opt
    INSTALL_PREFIX_BIN_DIR: ${INSTALL_PREFIX_DIR}/bin
    PATH: ${INSTALL_PREFIX_BIN_DIR}:${PATH}

  pre:
    # realpath needed by test.sh
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; sudo apt-get install realpath

      # We need gcc/g++ 5 because options -Wpednatic and -std
      # are not in older compilers and they generate unknown
      # command line option errors. The update-alternatives
      # makes the compilers the default.
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; sudo apt-get update; sudo apt-get install gcc-5; sudo apt-get install g++-5
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 100
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 100

checkout:
  post:
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; git submodule sync --recursive
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; git submodule update --recursive --init

dependencies:
  cache_directories:
    #- ${INSTALL_PREFIX_DIR_HOME_REL} # This doesn't work.
    - ~/opt

  pre:
    # Install the tools we need
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; vendor-install-tools/install.py meson --installPrefixDir=${INSTALL_PREFIX_DIR}
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; vendor-install-tools/install.py ninja --installPrefixDir=${INSTALL_PREFIX_DIR}

  override:
    # verfiy the tools are installed
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; which meson
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; meson -v
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; vendor-install-tools/test.sh meson
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; which ninja
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; ninja --version
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; vendor-install-tools/test.sh ninja

  post:
    # Create the build directory
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; mkdir -p build

test:
  pre:
    # Instruct meson to create the build.ninja file
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; cd build && meson ..

  override:
    # Do a default build
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; cd build && ninja
    # Run the application
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; cd build && ninja run
    # Clean
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; cd build && ninja clean
    # Build and test
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; cd build && ninja test
    # Retest without the need for a build
    - echo "${CIRCLE_NODE_INDEX}/${CIRCLE_NODE_TOTAL}: "; cd build && ninja test
